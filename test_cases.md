# Тест-кейсы для системы парсинга отзывов 2GIS и Telegram-бота

## 1. Тесты парсера отзывов

### TC-P001: Корректность загрузки отзывов по branch_id
**Предусловие:** Доступен API 2GIS, существует филиал с известным branch_id
**Шаги:**
1. Запустить парсер для конкретного branch_id
2. Проверить количество загруженных отзывов
3. Проверить наличие всех обязательных полей

**Ожидаемый результат:**
- Загружены все отзывы филиала
- Каждый отзыв содержит: review_id, branch_id, user_name, rating, text, date_created

### TC-P002: Обработка отзывов с фотографиями
**Шаги:**
1. Запустить парсер для филиала с отзывами с фото
2. Проверить сохранение photos_count и photos_urls

**Ожидаемый результат:**
- photos_count корректно отражает количество фото
- photos_urls содержит действительные URL изображений

### TC-P003: Предотвращение дублирования отзывов
**Шаги:**
1. Запустить парсинг филиала
2. Повторно запустить парсинг того же филиала
3. Проверить количество отзывов в БД

**Ожидаемый результат:**
- Дубликаты отзывов не создаются
- Количество отзывов не увеличивается при повторном парсинге

### TC-P004: Обработка пагинации (limit=50)
**Шаги:**
1. Запустить парсинг филиала с >50 отзывами
2. Проверить корректность загрузки всех страниц

**Ожидаемый результат:**
- Загружены все отзывы, не только первые 50

### TC-P005: Обработка ошибок API
**Шаги:**
1. Симулировать недоступность API (неверный URL/ключ)
2. Запустить парсинг

**Ожидаемый результат:**
- Ошибка логируется
- Парсер не падает, продолжает работу с другими филиалами

## 2. Тесты Telegram-бота

### TC-B001: Регистрация нового пользователя
**Шаги:**
1. Отправить команду /start
2. Проверить создание записи в таблице telegram_users

**Ожидаемый результат:**
- Пользователь сохранен с корректными данными
- Показано главное меню

### TC-B002: Подписка на филиалы (мультиселект)
**Шаги:**
1. Нажать "Подписаться на уведомления"
2. Выбрать несколько филиалов
3. Подтвердить выбор

**Ожидаемый результат:**
- Созданы записи в telegram_subscriptions
- Кнопки филиалов отмечены ✅

### TC-B003: Получение уведомления о новом отзыве
**Шаги:**
1. Подписаться на филиал
2. Добавить новый отзыв в БД
3. Запустить отправку уведомлений

**Ожидаемый результат:**
- Получено уведомление с текстом отзыва, рейтингом, автором
- Если есть фото - показаны фотографии

### TC-B004: Фильтрация отзывов по датам
**Шаги:**
1. Выбрать "Просмотр отзывов"
2. Выбрать филиал
3. Указать период через календарь

**Ожидаемый результат:**
- Показаны только отзывы за выбранный период
- Календарь работает корректно

### TC-B005: Кнопка "Подписаться на все"
**Шаги:**
1. В меню подписок нажать "Подписаться на все"
2. Проверить статус всех филиалов

**Ожидаемый результат:**
- Все филиалы отмечены ✅
- Кнопка изменилась на "Отписаться от всех"

### TC-B006: Управление подписками
**Шаги:**
1. Подписаться на несколько филиалов
2. Отписаться от одного филиала
3. Проверить список активных подписок

**Ожидаемый результат:**
- Подписка деактивирована
- В главном меню отображается корректный список

### TC-B007: Обработка пустых результатов
**Шаги:**
1. Выбрать период без отзывов
2. Запросить отзывы

**Ожидаемый результат:**
- Показано сообщение "Нет отзывов за выбранный период"

### TC-B008: Лимиты Telegram API
**Шаги:**
1. Создать >30 новых отзывов
2. Запустить массовую рассылку

**Ожидаемый результат:**
- Соблюдаются лимиты (не более 30 сообщений в секунду)
- Все уведомления доставлены

## 3. Интеграционные тесты

### TC-I001: Полный цикл от парсинга до уведомления
**Шаги:**
1. Подписать пользователя на филиал
2. Запустить инкрементальный парсинг
3. Проверить получение уведомлений

**Ожидаемый результат:**
- Новые отзывы сохранены в БД
- Уведомления отправлены подписчикам
- Поле sent_to_telegram = true

### TC-I002: Работа cron задания
**Шаги:**
1. Проверить настройку cron (3:00 ежедневно)
2. Дождаться автоматического запуска
3. Проверить логи

**Ожидаемый результат:**
- Парсинг запускается автоматически
- Создается отчет в parse_reports
- Логи сохраняются в файл

## 4. Тесты производительности

### TC-PF001: Загрузка большого количества отзывов
**Шаги:**
1. Запустить парсинг всех 20 филиалов
2. Измерить время выполнения

**Ожидаемый результат:**
- Парсинг завершается за разумное время
- Нет утечек памяти

### TC-PF002: Обработка большого количества подписчиков
**Шаги:**
1. Создать 100+ подписчиков
2. Отправить массовую рассылку

**Ожидаемый результат:**
- Все получают уведомления
- Нет таймаутов

## 5. Тесты безопасности

### TC-S001: Валидация входных данных
**Шаги:**
1. Попытаться внедрить SQL инъекцию через поиск
2. Отправить специальные символы в тексте

**Ожидаемый результат:**
- Данные корректно экранируются
- Система не падает

### TC-S002: Защита API endpoints
**Шаги:**
1. Попытаться получить доступ без авторизации
2. Проверить CORS заголовки

**Ожидаемый результат:**
- API доступен публично (как задумано)
- CORS настроен корректно