#!/usr/bin/env python3
"""
–¢–µ—Å—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ —Å Telegram-–±–æ—Ç–æ–º
"""
import os
import sys
sys.path.append('/root/projects/reviews-parser')

from datetime import datetime, timedelta
from database import SessionLocal, TelegramUser, TelegramSubscription
from telegram_analytics import generate_analytics_report

def test_telegram_integration():
    """–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Telegram-–±–æ—Ç–æ–º"""
    print("ü§ñ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ —Å Telegram-–±–æ—Ç–æ–º...")
    
    # –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏ –ë–î
    db = SessionLocal()
    
    try:
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        print("üë• –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...")
        users = db.query(TelegramUser).limit(3).all()
        
        for user in users:
            print(f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user.first_name} (@{user.username})")
            
            # –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–æ–∫
            subscriptions = db.query(TelegramSubscription).filter(
                TelegramSubscription.user_id == user.user_id,
                TelegramSubscription.is_active == True
            ).all()
            
            print(f"  üìù –ü–æ–¥–ø–∏—Å–æ–∫: {len(subscriptions)}")
            
            if subscriptions:
                # –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ —Ñ–∏–ª–∏–∞–ª–∞
                sub = subscriptions[0]
                print(f"  üè™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è: {sub.branch_name}")
                
                # –ü–µ—Ä–∏–æ–¥ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 14 –¥–Ω–µ–π
                date_to = datetime.now()
                date_from = date_to - timedelta(days=14)
                
                try:
                    report = generate_analytics_report(
                        db, sub.branch_id, sub.branch_name, date_from, date_to
                    )
                    
                    print(f"  ‚úÖ –û—Ç—á–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –¥–ª—è {sub.branch_name}")
                    print(f"  üìä –†–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–æ–≤–æ–π —Å–≤–æ–¥–∫–∏: {len(report['summary_text'])} —Å–∏–º–≤–æ–ª–æ–≤")
                    
                    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–≤—ã—Ö —Å—Ç—Ä–æ–∫ —Ç–µ–∫—Å—Ç–æ–≤–æ–π —Å–≤–æ–¥–∫–∏
                    first_lines = report['summary_text'].split('\n')[:3]
                    print(f"  üìù –ù–∞—á–∞–ª–æ —Å–≤–æ–¥–∫–∏: {first_lines[0]}")
                    
                    # –û—á–∏—Å—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤
                    from telegram_analytics import TelegramAnalytics
                    analytics = TelegramAnalytics(db)
                    analytics.cleanup_temp_files(report['temp_files'])
                    
                except Exception as e:
                    print(f"  ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞: {e}")
                
                break  # –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        
        print("‚úÖ –¢–µ—Å—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω!")
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏: {e}")
        import traceback
        traceback.print_exc()
        
    finally:
        db.close()

def test_menu_structure():
    """–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –º–µ–Ω—é"""
    print("üéØ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –º–µ–Ω—é...")
    
    # –ò–º–∏—Ç–∞—Ü–∏—è –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é —Å –ø–æ–¥–ø–∏—Å–∫–∞–º–∏
    print("üì± –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é (—Å –ø–æ–¥–ø–∏—Å–∫–∞–º–∏):")
    print("  üìä –ü—Ä–æ—Å–º–æ—Ç—Ä –æ—Ç–∑—ã–≤–æ–≤")
    print("  üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞")  # –ù–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞
    print("  üìù –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∞–º–∏")
    print("  ‚ÑπÔ∏è –ü–æ–º–æ—â—å")
    
    # –ò–º–∏—Ç–∞—Ü–∏—è —Å–ø—Ä–∞–≤–∫–∏
    print("\nüìö –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Å–ø—Ä–∞–≤–∫–∞:")
    help_text = """‚ÑπÔ∏è –°–ø—Ä–∞–≤–∫–∞ –ø–æ –±–æ—Ç—É

üîî –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:
‚Ä¢ –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∏–ª–∏–∞–ª—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –Ω–æ–≤—ã—Ö –æ—Ç–∑—ã–≤–∞—Ö
‚Ä¢ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏—Ö–æ–¥—è—Ç –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

üìä –ü—Ä–æ—Å–º–æ—Ç—Ä –æ—Ç–∑—ã–≤–æ–≤:
‚Ä¢ –ü—Ä–æ—Å–º–æ—Ç—Ä –æ—Ç–∑—ã–≤–æ–≤ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥
‚Ä¢ –û—Ç–∑—ã–≤—ã –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –ø–æ 5 —à—Ç—É–∫

üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞:
‚Ä¢ –ì—Ä–∞—Ñ–∏–∫–∏ –¥–∏–Ω–∞–º–∏–∫–∏ —Ä–µ–π—Ç–∏–Ω–≥–∞ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ—Ç–∑—ã–≤–æ–≤
‚Ä¢ –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–∑—ã–≤–æ–≤ –ø–æ –æ—Ü–µ–Ω–∫–∞–º
‚Ä¢ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º–∏ –ø–µ—Ä–∏–æ–¥–∞–º–∏

üìù –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∞–º–∏:
‚Ä¢ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫
‚Ä¢ –û—Ç–ø–∏—Å–∫–∞ –æ—Ç –≤—Å–µ—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

‚ùì –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"""
    
    print(help_text)
    
    print("\n‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–µ–Ω—é –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞!")

if __name__ == "__main__":
    test_telegram_integration()
    print("\n" + "="*50)
    test_menu_structure()